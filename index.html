<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Villa Budget App</title>
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; /* จำกัดความกว้างสำหรับมือถือ */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* HEADER & STATUS BAR */
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        .status-bar {
            display: flex;
            align-items: center;
            font-size: 0.85em;
        }

        .user-status {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .user-status span {
            margin-left: 5px;
            font-weight: bold;
        }

        .balance-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.2em;
            font-weight: 700;
            color: #28a745; /* สีเขียวสำหรับยอดคงเหลือ */
        }

        .negative {
            color: #dc3545; /* สีแดงสำหรับติดลบ */
        }

        .sub-balance-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.8em;
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            background-color: #eee;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #fff;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 10px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        select {
            appearance: none;
            background: #fff url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%20197.8L151.2%2062.2a14.3%2014.3%200%200%200-20.1%200L5.3%20197.8c-7.1%207.1-7.1%2018.6%200%2025.7s18.6%207.1%2025.7%200l113.8-113.8L261.3%20223.5c7.1%207.1%2018.6%207.1%2025.7%200s7.1-18.6%200-25.7z%22%2F%3E%3C%2Fsvg%3E') no-repeat right 10px center;
            background-size: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            margin-top: 10px;
        }
        
        .btn-danger:hover {
            background-color: #b02a37;
        }

        /* DATA LISTS (TRANSACTIONS & ESTIMATES) */
        .data-list {
            margin-top: 15px;
        }

        .data-item {
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-description {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 3px;
        }

        .item-meta {
            font-size: 0.85em;
            color: #6c757d;
        }

        .item-amount {
            font-weight: 700;
            font-size: 1.2em;
            margin-left: 10px;
        }

        .income {
            color: #28a745;
        }

        .expense {
            color: #dc3545;
        }
        
        .estimate-item {
            border-left: 5px solid #ffc107; /* สีเหลืองสำหรับรายการประเมิน */
        }
        
        .estimate .item-amount {
            color: #ffc107;
        }

        .data-list h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .delete-btn, .forward-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            padding: 0;
            width: auto;
            transition: color 0.2s;
        }
        
        .forward-btn {
            color: #007bff;
        }

        .delete-btn:hover, .forward-btn:hover {
            color: #000;
        }
        
        /* LOGIN PAGE */
        .login-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-form {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 350px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #007bff;
        }

        /* NOTIFICATION */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            color: white;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification-bar.show {
            display: block;
            opacity: 1;
        }

        .notification-bar.success {
            background-color: #28a745;
        }

        .notification-bar.error {
            background-color: #dc3545;
        }

        .notification-bar.info {
            background-color: #ffc107;
            color: #333;
        }
        
        /* SETTLEMENT TABLE */
        .settlement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .settlement-table th, .settlement-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        
        .settlement-table th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .settlement-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .settlement-table .net-balance-cell {
            font-weight: bold;
        }
        
        .settlement-table .credit {
            color: #28a745;
        }
        
        .settlement-table .debt {
            color: #dc3545;
        }

        /* MOBILE OPTIMIZATION */
        @media (min-width: 601px) {
            .container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body>

    <div class="notification-bar" id="notificationBar"></div>

    <div id="mainApp" style="display: none;">
        <header>
            <h1 id="accountNameTitle">Pool Villa Budget App</h1>
            <div class="status-bar">
                <div class="user-status">
                    🧑 <span id="loggedInUser"></span>
                </div>
                <button onclick="logout()" style="background-color: transparent; color: white; border: 1px solid white; padding: 5px 10px; font-size: 0.8em; margin-left: 10px; width: auto;">
                    Logout
                </button>
            </div>
        </header>
        
        <div class="container">
            <div id="balanceBox" class="balance-box">
                <div class="balance-title">ยอดเงินที่ใช้ได้จริง (หลังหักยอดประเมิน)</div>
                <div id="availableBalance" class="balance-amount">0.00</div>
                <div class="sub-balance-info">
                    <span>คงเหลือจริง: <span id="currentBalance">0.00</span></span>
                    <span>ยอดประเมิน: <span id="totalEstimate">0.00</span></span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'AddTransaction')">บันทึก</button>
                <button class="tab-button" onclick="openTab(event, 'ViewData')">รายการ</button>
                <button class="tab-button" onclick="openTab(event, 'Settlement')">สรุปบัญชี</button>
                <button class="tab-button" onclick="openTab(event, 'Advanced')">จัดการ</button>
            </div>

            <div id="AddTransaction" class="tab-content active">
                <div class="form-group">
                    <label for="transactionType">ประเภทรายการ</label>
                    <select id="transactionType" onchange="toggleIncomeExpenseFields()">
                        <option value="EXPENSE">รายจ่าย</option>
                        <option value="INCOME">รายรับ</option>
                    </select>
                </div>
                
                <div id="expenseFields">
                    <div class="form-group">
                        <label for="expensePaidBy">ผู้จ่ายเงินออกไปก่อน (Credit)</label>
                        <select id="expensePaidBy" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">ประเภทการจ่าย</label>
                        <select id="paymentType" required>
                            <option value="POOL">จ่ายจากกองกลาง (Pool)</option>
                            <option value="INDIVIDUAL">จ่ายส่วนตัวไปก่อน (หารเฉลี่ย)</option>
                        </select>
                    </div>
                </div>
                
                <div id="incomeFields" style="display:none;">
                    <div class="form-group">
                        <label for="incomeMember">สมาชิกผู้จ่ายเข้ากองกลาง</label>
                        <select id="incomeMember">
                            <option value="">-- เป็นเงิน Sponsor (ไม่ได้เครดิต) --</option>
                            </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transactionAmount">จำนวนเงิน</label>
                    <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionDescription">คำอธิบาย/รายละเอียด</label>
                    <input type="text" id="transactionDescription" placeholder="ค่าอาหาร, ค่าน้ำมัน, ฯลฯ" required>
                </div>
                
                <button class="btn-primary" onclick="addTransaction()">บันทึกรายการ</button>
                
                <h3 style="margin-top: 30px;">บันทึกรายการประเมิน (Estimate)</h3>
                <p style="font-size: 0.9em; color: #666;">ยอดนี้จะถูกหักออกจากยอดเงินที่ใช้ได้ทันที แต่ยังไม่ถูกบันทึกเป็นรายจ่ายจริง</p>
                <div class="form-group">
                    <label for="estimateAmount">จำนวนเงินที่คาดว่าจะใช้</label>
                    <input type="number" id="estimateAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="estimateDescription">คำอธิบายรายการประเมิน</label>
                    <input type="text" id="estimateDescription" placeholder="งบประมาณซื้อของ">
                </div>
                <button class="btn-primary" onclick="addEstimate()">บันทึกรายการประเมิน</button>
            </div>

            <div id="ViewData" class="tab-content">
                <h3>รายการรายจ่าย/รายรับทั้งหมด</h3>
                <div id="transactionList" class="data-list">
                    </div>
                
                <h3 style="margin-top: 30px;">รายการประเมินที่ค้างอยู่</h3>
                <div id="estimateList" class="data-list">
                    </div>
            </div>

            <div id="Settlement" class="tab-content">
                <h3>สรุปยอดหนี้สิน/เครดิตส่วนตัว</h3>
                <p style="font-size: 0.9em; color: #666;">ยอดบวกคือ **เครดิต (ต้องได้รับคืน)**, ยอดลบคือ **หนี้ (ต้องจ่ายเพิ่ม)**</p>
                
                <table id="settlementTable" class="settlement-table">
                    <thead>
                        <tr>
                            <th>สมาชิก</th>
                            <th>จ่ายล่วงหน้า (Advance)</th>
                            <th>ยอดจ่ายไปก่อน (Credit)</th>
                            <th>ยอดรับผิดชอบ (Debit)</th>
                            <th>ยอดสุทธิ (Net)</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                
                <h3 style="margin-top: 20px;">รายการเบิกเงินล่วงหน้า (Advance)</h3>
                <div id="advanceList" class="data-list">
                    </div>
            </div>

            <div id="Advanced" class="tab-content">
                <h3>เพิ่มสมาชิกใหม่</h3>
                <div class="form-group">
                    <label for="newMemberName">ชื่อสมาชิก</label>
                    <input type="text" id="newMemberName" placeholder="ชื่อเล่น หรือชื่อจริง" required>
                </div>
                <button class="btn-primary" onclick="addMember()">เพิ่มสมาชิก</button>
                
                <h3 style="margin-top: 30px;">บันทึกการเบิกเงินล่วงหน้า (Advance)</h3>
                <div class="form-group">
                    <label for="advanceMember">สมาชิกที่เบิกเงิน</label>
                    <select id="advanceMember" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="advanceAmount">จำนวนเงินที่เบิก</label>
                    <input type="number" id="advanceAmount" placeholder="0.00" step="0.01" required>
                </div>
                <button class="btn-primary" onclick="addAdvance()">บันทึกการเบิก</button>
                
                <button class="btn-danger" style="margin-top: 50px;" onclick="clearActiveUsers()">เคลียร์ผู้ใช้งานค้าง (ฉุกเฉิน)</button>
            </div>

        </div> </div> <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>Pool Villa Budget App</h2>
            <div class="form-group">
                <label for="loginUser">ชื่อผู้ใช้งาน</label>
                <input type="text" id="loginUser" placeholder="เช่น สมชาย, ผู้ดูแล" required>
            </div>
            <div class="form-group">
                <label for="passcode">รหัสผ่าน</label>
                <input type="password" id="passcode" required>
            </div>
            <button class="btn-primary" onclick="login()">เข้าสู่ระบบ</button>
        </div>
    </div>
    
    <script>
        // *** 1. CONFIGURATION & STATE ***
        const LOGGED_IN_USER_KEY = 'poolVillaBudgetAppUser';
        let allMembers = []; // เก็บรายชื่อสมาชิกทั้งหมด
        let currentData = {}; // เก็บข้อมูลทั้งหมดที่โหลดมาจาก Apps Script

        // *** 2. CORE APIS ***
        // Core API Call (Uses GET method for all data exchange)
        function postData(payload) {
            return new Promise((resolve, reject) => {
                // ต้องมี checkAutoLogin(); เพื่อจัดการ Redirect ถ้า Session หมดอายุ
                // checkAutoLogin(); 
                
                google.script.run
                    .withSuccessHandler(result => {
                        // ถ้าเกิด Error ใน Server (Code.gs) จะส่ง success: false กลับมา
                        if (result && result.success === false) {
                             reject(result.message || 'Server returned failure.');
                             return;
                        }
                        resolve(result);
                    })
                    .withFailureHandler(error => {
                        // ถ้าเกิด Error ในการเชื่อมต่อ (เช่น Script function not found)
                        console.error('Apps Script Call Failed:', error);
                        reject(error);
                    })
                    .doGet(payload); // เรียก doGet ใน Code.gs 
            });
        }
        
        // --- DATA RETRIEVAL ---
        async function loadAllData() {
            try {
                // โหลดข้อมูลหลัก (Transactions, Estimates, Balances)
                const payload = { action: 'GET_DATA' };
                const result = await postData(payload);

                if (result.success) {
                    currentData = result;
                    updateBalanceBox(result);
                    renderTransactions(result.transactions);
                    renderEstimates(result.estimates);
                    
                    // โหลดและ render Settlement Data 
                    const settlementPayload = { action: 'GET_SETTLEMENT_DATA' };
                    const settlementResult = await postData(settlementPayload);
                    if (settlementResult.success) {
                        renderSettlement(settlementResult);
                    } else {
                        throw new Error(settlementResult.message);
                    }
                    
                    showNotification('อัปเดตข้อมูลสำเร็จ', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification(`โหลดข้อมูลล้มเหลว: ${error.toString()}`, 'error');
            }
        }
        
        // โหลดเฉพาะรายชื่อสมาชิกสำหรับการ Login
        // async function loadLoginData() {
            // try {
            //     const result = await postData({ action: 'GET_MEMBERS' });
            //     if (result.success && result.members) {
            //         allMembers = result.members;
            //         populateMemberSelects();
            //         // populate Login dropdown
            //         const loginSelect = document.getElementById('loginUser');
            //         loginSelect.innerHTML = '<option value="">-- เลือกผู้ใช้ --</option>';
            //         result.members.forEach(member => {
            //             const option = document.createElement('option');
            //             option.value = member;
            //             option.textContent = member;
            //             loginSelect.appendChild(option);
            //         });
            //     } else {
            //         showNotification('ไม่พบรายชื่อสมาชิก', 'error');
            //     }
            // } catch (error) {
            //     showNotification(`โหลดข้อมูล Login ล้มเหลว: ${error.toString()}`, 'error');
            // }
        // }
        
        // --- UTILITY ---
        function formatCurrency(amount) {
            if (typeof amount !== 'number') return 'N/A';
            return amount.toLocaleString('th-TH', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }) + ' ฿';
        }
        
        function populateMemberSelects() {
            const selects = [
                document.getElementById('expensePaidBy'),
                document.getElementById('incomeMember'),
                document.getElementById('advanceMember')
            ];
            
            selects.forEach(select => {
                const selectedValue = select.id === 'incomeMember' ? select.value : localStorage.getItem(LOGGED_IN_USER_KEY);
                select.innerHTML = '';
                
                if (select.id === 'incomeMember') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- เป็นเงิน Sponsor (ไม่ได้เครดิต) --';
                    select.appendChild(defaultOption);
                }
                
                allMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                    
                    if (member === selectedValue) {
                        option.selected = true;
                    }
                });
            });
        }
        
        // *** 3. UI RENDERING ***
        function updateBalanceBox(data) {
            const availableBalanceEl = document.getElementById('availableBalance');
            const currentBalanceEl = document.getElementById('currentBalance');
            const totalEstimateEl = document.getElementById('totalEstimate');
            
            const available = parseFloat(data.availableBalance) || 0;
            const current = parseFloat(data.currentBalance) || 0;
            const estimate = parseFloat(data.totalEstimate) || 0;

            availableBalanceEl.textContent = formatCurrency(available);
            availableBalanceEl.classList.toggle('negative', available < 0);
            
            currentBalanceEl.textContent = formatCurrency(current);
            totalEstimateEl.textContent = formatCurrency(estimate);

            document.getElementById('accountNameTitle').textContent = data.accountName || 'Pool Villa Budget App';
        }

        function renderTransactions(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';

            transactions.slice().reverse().forEach((t, index) => {
                const originalIndex = transactions.length - 1 - index; // คำนวณ Index ของแถวใน Sheet
                
                const item = document.createElement('div');
                item.className = 'data-item';
                
                const amount = parseFloat(t.Amount) || 0;
                const typeClass = t.Type === 'INCOME' ? 'income' : 'expense';
                
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${t.Description || 'ไม่มีคำอธิบาย'}</div>
                        <div class="item-meta">
                            ${t.Type} | ${t.PaidBy ? 'จ่ายโดย: ' + t.PaidBy + ' (' + t.PaymentType + ')' : ''} |
                            ${new Date(t.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount ${typeClass}">${formatCurrency(amount)}</div>
                    <button class="delete-btn" onclick="deleteTransaction(${originalIndex})" title="ลบรายการ">🗑️</button>
                `;
                list.appendChild(item);
            });
            
            if (transactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">ไม่พบรายการรายรับ/รายจ่าย</p>';
            }
        }

        function renderEstimates(estimates) {
            const list = document.getElementById('estimateList');
            list.innerHTML = '';
            
            estimates.slice().reverse().forEach((e, index) => {
                const originalIndex = estimates.length - 1 - index;
                
                const item = document.createElement('div');
                item.className = 'data-item estimate-item';
                
                const amount = parseFloat(e.Amount) || 0;
                
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${e.Description || 'ไม่มีคำอธิบาย'}</div>
                        <div class="item-meta">
                            ประเมินโดย: ${e.User} |
                            ${new Date(e.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount estimate">${formatCurrency(amount)}</div>
                    <button class="forward-btn" onclick="forwardEstimate(${originalIndex})" title="บันทึกเป็นรายจ่ายจริง">✅</button>
                    <button class="delete-btn" onclick="deleteEstimate(${originalIndex})" title="ยกเลิก/ลบประเมิน">🗑️</button>
                `;
                list.appendChild(item);
            });
            
            if (estimates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">ไม่พบรายการประเมินที่ค้างอยู่</p>';
            }
        }
        
        function renderSettlement(data) {
            const tableBody = document.querySelector('#settlementTable tbody');
            const advanceList = document.getElementById('advanceList');
            tableBody.innerHTML = '';
            advanceList.innerHTML = '';

            const settlementData = data.settlementData;
            const members = data.members;

            members.forEach(member => {
                const s = settlementData[member] || { paidOut: 0, advanceDebt: 0, baseDebit: 0, netBalance: 0 };
                const netClass = s.netBalance >= 0 ? 'credit' : 'debt';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${member}</td>
                    <td>${formatCurrency(s.advanceDebt)}</td>
                    <td class="credit">${formatCurrency(s.paidOut)}</td>
                    <td class="debt">${formatCurrency(s.baseDebit)}</td>
                    <td class="net-balance-cell ${netClass}">${formatCurrency(s.netBalance)}</td>
                `;
            });
            
            // Render Advance List
            const advanceData = currentData.advance || [];
            advanceData.slice().reverse().forEach(a => {
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">เบิกโดย ${a.MemberName}</div>
                        <div class="item-meta">
                            ${new Date(a.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount debt">${formatCurrency(parseFloat(a.Amount) || 0)}</div>
                `;
                advanceList.appendChild(item);
            });
            
            if (advanceData.length === 0) {
                advanceList.innerHTML = '<p style="text-align: center; color: #999;">ไม่พบรายการเบิกเงินล่วงหน้า</p>';
            }
        }
        
        // *** 4. AUTHENTICATION & SESSION ***
        async function login() {
            const user = document.getElementById('loginUser').value;
            const passcode = document.getElementById('passcode').value;

            if (!user || !passcode) {
                showNotification('กรุณาเลือกผู้ใช้และใส่รหัสผ่าน', 'error');
                return;
            }
            
            showNotification('กำลังเข้าสู่ระบบ...', 'info', 60000); // 1 นาที
            
            try {
                const payload = { action: 'LOGIN', user: user, passcode: passcode };
                const result = await postData(payload);

                if (result.success) {
                    localStorage.setItem(LOGGED_IN_USER_KEY, result.user);
                    document.getElementById('loggedInUser').textContent = result.user;
                    document.getElementById('accountNameTitle').textContent = result.accountName;
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                    
                    populateMemberSelects(); // Set default PaidBy to logged-in user
                    await loadAllData();
                    showNotification('เข้าสู่ระบบสำเร็จ', 'success');
                } else {
                    showNotification(`เข้าสู่ระบบล้มเหลว: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`ข้อผิดพลาดในการเชื่อมต่อ: ${error.toString()}`, 'error');
            }
        }

        function logout() {
            if (!confirm('คุณต้องการออกจากระบบใช่หรือไม่?')) return;
            
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            if (user) {
                postData({ action: 'LOGOUT', user: user })
                    .then(result => {
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('ออกจากระบบสำเร็จ', 'success');
                        loadLoginData(); // โหลดข้อมูล Login ใหม่
                    })
                    .catch(error => {
                        // Logout fails on server but we clear client session anyway
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('ออกจากระบบ (มีข้อผิดพลาดเล็กน้อย)', 'info');
                        loadLoginData();
                    });
            }
        }
        
        function checkAutoLogin() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            if (user) {
                // Try System check to verify session
                postData({ action: 'LOGIN', user: 'System', passcode: 'System' }) 
                    .then(result => {
                        if (result.success) {
                            document.getElementById('loggedInUser').textContent = user;
                            document.getElementById('accountNameTitle').textContent = result.accountName;
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainApp').style.display = 'flex';
                            populateMemberSelects();
                            loadAllData();
                        } else {
                            // System check failed, force login
                            localStorage.removeItem(LOGGED_IN_USER_KEY);
                            document.getElementById('mainApp').style.display = 'none';
                            document.getElementById('loginScreen').style.display = 'flex';
                            loadLoginData();
                        }
                    })
                    .catch(error => {
                        // Hard error, assume no connection, force login
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('ไม่สามารถเชื่อมต่อ Server ได้', 'error');
                        loadLoginData();
                    });
            } else {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                loadLoginData();
            }
        }

        // *** 5. ACTIONS ***
        
        // Toggle Income/Expense Fields
        function toggleIncomeExpenseFields() {
            const type = document.getElementById('transactionType').value;
            document.getElementById('expenseFields').style.display = (type === 'EXPENSE') ? 'block' : 'none';
            document.getElementById('incomeFields').style.display = (type === 'INCOME') ? 'block' : 'none';
        }
        
        // Add Transaction (Income/Expense)
        async function addTransaction() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const type = document.getElementById('transactionType').value;
            const amount = document.getElementById('transactionAmount').value;
            const description = document.getElementById('transactionDescription').value;
            
            if (!amount || !description || parseFloat(amount) <= 0) {
                showNotification('กรุณากรอกจำนวนเงินและรายละเอียดให้ถูกต้อง', 'error');
                return;
            }
            
            let payload = { 
                action: 'ADD_TRANSACTION',
                user: user,
                type: type,
                amount: amount,
                description: description
            };

            if (type === 'EXPENSE') {
                payload.paidBy = document.getElementById('expensePaidBy').value;
                payload.paymentType = document.getElementById('paymentType').value;
                if (!payload.paidBy || !payload.paymentType) {
                    showNotification('กรุณาเลือกผู้จ่ายและประเภทการจ่าย', 'error');
                    return;
                }
            } else if (type === 'INCOME') {
                payload.incomeMember = document.getElementById('incomeMember').value; // สามารถเป็นค่าว่างได้
            }

            showNotification('กำลังบันทึกรายการ...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('บันทึกรายการสำเร็จ', 'success');
                    document.getElementById('transactionAmount').value = '';
                    document.getElementById('transactionDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`บันทึกรายการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`บันทึกรายการล้มเหลว: ${error.toString()}`, 'error');
            }
        }

        // Add Estimate
        async function addEstimate() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const amount = document.getElementById('estimateAmount').value;
            const description = document.getElementById('estimateDescription').value;
            
            if (!amount || !description || parseFloat(amount) <= 0) {
                showNotification('กรุณากรอกจำนวนเงินและรายละเอียดประเมินให้ถูกต้อง', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_ESTIMATE',
                user: user,
                amount: amount,
                description: description
            };

            showNotification('กำลังบันทึกรายการประเมิน...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('บันทึกรายการประเมินสำเร็จ', 'success');
                    document.getElementById('estimateAmount').value = '';
                    document.getElementById('estimateDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`บันทึกรายการประเมินล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`บันทึกรายการประเมินล้มเหลว: ${error.toString()}`, 'error');
            }
        }

        // Add Member
        async function addMember() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const memberName = document.getElementById('newMemberName').value.trim();
            
            if (!memberName) {
                showNotification('กรุณาใส่ชื่อสมาชิก', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_MEMBER',
                user: user,
                memberName: memberName
            };

            showNotification('กำลังเพิ่มสมาชิก...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('เพิ่มสมาชิกสำเร็จ', 'success');
                    document.getElementById('newMemberName').value = '';
                    await loadLoginData(); // Reload member list for all dropdowns
                } else {
                    showNotification(`เพิ่มสมาชิกไม่สำเร็จ: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`เพิ่มสมาชิกไม่สำเร็จ: ${error.toString()}`, 'error');
            }
        }
        
        // Add Advance
        async function addAdvance() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const memberName = document.getElementById('advanceMember').value;
            const amount = document.getElementById('advanceAmount').value;
            
            if (!memberName || !amount || parseFloat(amount) <= 0) {
                showNotification('กรุณาเลือกสมาชิกและใส่จำนวนเงินให้ถูกต้อง', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_ADVANCE',
                user: user,
                memberName: memberName,
                amount: amount
            };

            showNotification('กำลังบันทึกการเบิกเงิน...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('บันทึกการเบิกเงินสำเร็จ', 'success');
                    document.getElementById('advanceAmount').value = '';
                    await loadAllData();
                } else {
                    showNotification(`บันทึกการเบิกเงินล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`บันทึกการเบิกเงินล้มเหลว: ${error.toString()}`, 'error');
            }
        }

        // Delete Transaction
        async function deleteTransaction(dataIndex) {
            if (!confirm(`คุณต้องการลบรายการในแถวที่ ${dataIndex + 2} นี้ใช่หรือไม่?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_TRANSACTION',
                user: user,
                rowIndex: dataIndex // rowIndex is 0-based data index (excluding header)
            };

            showNotification('กำลังลบรายการ...', 'info', 60000);
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('ลบรายการสำเร็จ', 'success');
                await loadAllData(); 
            } else {
                showNotification(`ลบรายการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }
        
        // Delete Estimate
        async function deleteEstimate(dataIndex) {
            if (!confirm(`คุณต้องการลบรายการประเมินในแถวที่ ${dataIndex + 2} นี้ใช่หรือไม่?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };
            
            showNotification('กำลังลบรายการประเมิน...', 'info', 60000);
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('ลบรายการประเมินสำเร็จ', 'success');
                await loadAllData();
            } else {
                showNotification(`ลบรายการประเมินล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
            }
        }

        // Forward Estimate to Transaction
        async function forwardEstimate(dataIndex) {
            if (!confirm(`คุณต้องการเปลี่ยนรายการประเมินแถวที่ ${dataIndex + 2} เป็นรายการรายจ่ายจริงใช่หรือไม่? รายการเดิมจะถูกลบ`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'FORWARD_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            showNotification('กำลังเปลี่ยนเป็นรายจ่ายจริง...', 'info', 60000); 
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('บันทึกเป็นรายจ่ายจริงสำเร็จ', 'success');
                    await loadAllData(); // โหลดข้อมูลใหม่เพื่ออัปเดตทั้ง 2 แท็บและยอดคงเหลือ
                } else {
                    showNotification(`ดำเนินการล้มเหลว: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`ดำเนินการล้มเหลว: ${error.toString()}`, 'error');
            }
        }
        
        // Clear Active Users (Emergency)
        async function clearActiveUsers() {
            if (!confirm('คุณต้องการเคลียร์ Session ผู้ใช้งานค้างทั้งหมดใช่หรือไม่? ใช้ในกรณีฉุกเฉินเท่านั้น!')) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            showNotification('กำลังเคลียร์...', 'info', 60000);
            
            try {
                const result = await postData({ action: 'CLEAR_ACTIVE_USERS', user: user });
                if (result.success) {
                    showNotification('เคลียร์ผู้ใช้งานค้างสำเร็จ', 'success');
                } else {
                    showNotification(`เคลียร์ไม่สำเร็จ: ${result.message || 'ข้อผิดพลาด'}`, 'error');
                }
            } catch (error) {
                 showNotification(`เคลียร์ไม่สำเร็จ: ${error.toString()}`, 'error');
            }
        }

        // *** 6. UI UTILITIES ***

        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Reload data if needed for the tab
            if (tabName === 'Settlement' || tabName === 'ViewData') {
                loadAllData();
            }
            if (tabName === 'AddTransaction') {
                toggleIncomeExpenseFields();
            }
        }

        function showNotification(message, type, duration = 3000) {
            const bar = document.getElementById('notificationBar');
            
            // Clear previous classes
            bar.className = 'notification-bar';
            
            bar.textContent = message;
            bar.classList.add(type);
            
            // Ensure it's displayed
            requestAnimationFrame(() => {
                bar.classList.add('show');
            });
            

            if (duration > 0) {
                setTimeout(() => {
                    bar.classList.remove('show');
                }, duration);
            }
        }
        
        // Initialize on load
        window.onload = checkAutoLogin;
    </script>
</body>
</html>




