<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Villa Budget App</title>
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* HEADER & STATUS BAR */
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        /* BALANCE DISPLAY */
        #budget-display {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 5px; 
            font-size: 1.1em;
            font-weight: bold; 
            background-color: #e3f2fd; 
            color: #0d47a1; 
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #balance-display {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
            background-color: #ffffff; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

.balance-positive {
    color: #28a745; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
}

.balance-negative {
    color: #dc3545; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
}
        #account-name-display {
            font-weight: bold;
            font-size: 1.1em;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏° user info container */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #user-greeting-display {
            font-size: 0.8em;
            opacity: 0.9;
            margin-top: 2px;
        }
        #current-datetime {
            font-size: 0.85em;
            opacity: 0.8;
            text-align: right;
        }

        /* LOGIN SCREEN STYLES */
        #login-screen {
            padding: 40px 15px;
            text-align: center;
        }
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        /* BUTTON STYLES (Modern & Mobile-friendly) */
        .btn-primary {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            margin-top: 10px;
        }
        .btn-login {
            background-color: #28a745;
            color: white;
        }
        .btn-login:hover:not(:disabled) {
            background-color: #218838;
        }
        .btn-action {
            background-color: #007bff;
            color: white;
            margin-bottom: 15px;
        }
        .btn-action:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* MAIN CONTENT AREA */
        .content-section {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        /* NAVIGATION TABS (Mobile-friendly Grid) */
        /* ‚úÖ FIX: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tabs ‡∏´‡∏•‡∏±‡∏Å */
        .tab-buttons-main {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-buttons-sub { /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tab ‡∏¢‡πà‡∏≠‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏±‡∏ö/‡∏à‡πà‡∏≤‡∏¢ */
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 5px; /* ‡∏•‡∏î Padding ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 4 ‡∏õ‡∏∏‡πà‡∏° */
            border: 2px solid #007bff;
            border-radius: 10px;
            background-color: white;
            color: #007bff;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.85em; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå */
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
        }
        
        /* FORM LAYOUT (Simplified for Mobile) */
        .form-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .form-row label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-row input[type="number"],
        .form-row input[type="text"],
        .form-row select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        /* New Radio/Checkbox Group Style */
        .radio-group {
            display: flex;
            gap: 10px;
        }
        .radio-group label {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group input[type="radio"]:checked + label {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* TABLE STYLES (Mobile-friendly, Compact) */
        .transaction-table {
            width: 100%;
            border-collapse: collapse; 
            margin-top: 10px;
            font-size: 0.85em; 
        }

        .transaction-table th, .transaction-table td {
            padding: 8px 5px; 
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .transaction-table th {
            background-color: #f4f4f4;
            font-weight: bold;
            color: #555;
            position: sticky; 
            top: 0;
            z-index: 10;
        }

        .transaction-table td:nth-child(2) { 
            text-align: right;
            white-space: nowrap; 
            font-weight: bold;
        }

        .transaction-table td:last-child { 
            text-align: center; 
        }

        .transaction-table .income-row {
            background-color: #e6ffe6; 
        }

        .transaction-table .expense-row {
            background-color: #fff0f0; 
        }

        .transaction-table .delete-btn {
            padding: 3px 6px;
            font-size: 0.75em;
            margin-left: 0; 
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ */
        .scrollable-list {
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            padding: 0 10px; 
        }
        
        /* ALERT/TOAST NOTIFICATION (Stylish) */
        #notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .success { background-color: #28a745; }
        .error { background-color: #dc3545; }
        .info { background-color: #ffc107; color: #333; }
        .show { opacity: 1; display: block; }

        /* FOOTER & LOGOUT */
        footer {
            text-align: center;
            padding: 15px;
            margin-top: auto;
            color: #888;
            font-size: 0.8em;
        }
        #logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        #logout-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="notification"></div>

    <header>
        <div>
            <div id="account-name-display">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div>
            <span id="current-datetime"></span>
            <button id="logout-btn" style="display: none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>

    <div class="container">

        <section id="login-screen">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <input type="password" id="passcode" class="login-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            <input type="text" id="username" class="login-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" required>
            <button id="login-btn" class="btn-primary btn-login" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </section>

        <section id="app-screen" style="display: none;">
            
            <div id="budget-display">
                <strong>‡∏¢‡∏≠‡∏î‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏° (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î):</strong> 
                <span id="total-budget-amount">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</span>
            </div>

            <div id="balance-display">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠...
            </div>

            <div id="estimate-total-display" style="
                    text-align: center; 
                    padding: 5px 0; 
                    margin-bottom: 10px; 
                    font-size: 1.0em; 
                    color: #ffc107; 
                    font-weight: bold;
                    display: none; 
                    ">
                    ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: 
                    <span class="estimate-amount">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            
            <div class="tab-buttons-main">
                <button class="tab-button active" onclick="showTab('add')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                <button class="tab-button" onclick="showTab('estimate')">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢</button>
                <button class="tab-button" onclick="showTab('members')">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å/‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button class="tab-button" onclick="showTab('settlement')">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ</button>
            </div>

            <div id="add-tab" class="content-section">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏£‡∏±‡∏ö/‡∏à‡πà‡∏≤‡∏¢</h2>
                
                <div class="tab-buttons-sub" style="margin-bottom: 15px;">
                    <button id="btn-expense" class="tab-button active" data-type="EXPENSE">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                    <button id="btn-income" class="tab-button" data-type="INCOME">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                </div>

                <div id="income-member-group" class="form-row" style="display: none;">
                    <label for="income-member">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</label>
                    <select id="income-member" required>
                        <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Sponsor/‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏£‡∏ß‡∏°) --</option>
                    </select>
                </div>

                <div id="payment-type-group" class="form-row">
                    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)</label>
                    <div class="radio-group">
                        <input type="radio" id="pay-pool" name="payment-type" value="POOL" checked>
                        <label for="pay-pool">‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</label>
                        
                        <input type="radio" id="pay-advance" name="payment-type" value="ADVANCE">
                        <label for="pay-advance">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å</label>
                        
                        <input type="radio" id="pay-personal" name="payment-type" value="PERSONAL">
                        <label for="pay-personal">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô)</label>
                    </div>
                </div>

                <div id="paid-by-group" class="form-row">
                    <label for="paid-by-member">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (Paid By)</label>
                    <select id="paid-by-member" required>
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å --</option>
                    </select>
                </div>


                <div class="form-row">
                    <label for="transaction-description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <input type="text" id="transaction-description" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ" required>
                </div>

                <div class="form-row">
                    <label for="transaction-amount">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="number" id="transaction-amount" placeholder="0.00" required>
                </div>

                <button class="btn-primary btn-action" onclick="addTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>

            <div id="estimate-tab" class="content-section" style="display: none;">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h2>
                <div style="font-weight: bold; margin-bottom: 15px;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: <span id="total-estimate-display">0.00</span></div>

                <div id="estimate-list-container">
                    </div>

                <div class="content-section" style="margin-top: 15px;">
                    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h3>
                    
                    <div class="form-row">
                        <label for="estimate-description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                        <input type="text" id="estimate-description" placeholder="‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°" required>
                    </div>

                    <div class="form-row">
                        <label for="estimate-amount">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                        <input type="number" id="estimate-amount" placeholder="0.00" required>
                    </div>

                    <button class="btn-primary btn-action" onclick="addEstimate()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
                </div>
            </div>
            
            <div id="members-tab" class="content-section" style="display: none;">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å & ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</h2>
                
                <div id="member-list-container" class="content-section">
                    <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (<span id="member-count">0</span> ‡∏Ñ‡∏ô)</h3>
                    </div>
                
                <div class="content-section">
                    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="form-row">
                        <label for="new-member-name">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                        <input type="text" id="new-member-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" required>
                    </div>
                    <button class="btn-primary btn-action" onclick="addMember()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>

                <div class="content-section">
                    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Loan)</h3>
                    <div class="form-row">
                        <label for="advance-member">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
                        <select id="advance-member" required>
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å --</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="advance-amount">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
                        <input type="number" id="advance-amount" placeholder="0.00" required>
                    </div>
                    <button class="btn-primary btn-secondary" onclick="addAdvanceDraw()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</button>
                </div>

                <div id="advance-list-container" class="content-section">
                    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    </div>
            </div>

            <div id="settlement-tab" class="content-section" style="display: none;">
                <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ</h2>
                <p>‚ö†Ô∏è **‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤**</p>
                <p>‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (Paid By, Payment Type) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                
                <button class="btn-primary btn-action" onclick="showNotification('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ</button>
                
                <div id="settlement-summary">
                    </div>
            </div>

            <div class="list-section">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢)</h2>

                <div id="transactions-container" class="scrollable-list">
                    <table id="transactions-table" class="transaction-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                                <th style="width: 30%; text-align: right;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th style="width: 30%; text-align: center;"></th> 
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" class="no-data">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="data-display-section">
            </div>

            <div class="content-section">
                <h3>‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <p style="font-size: 1.5em; font-weight: bold;" id="visitor-count">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>

            <div class="content-section">
                <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <pre id="log-display"></pre>
            </div>
            

        </section>
    </div>

    <footer>
        <p>Pool Villa Budget App | Make by K-mew</p>
    </footer>

    <script>
        // *** 1. CONFIGURATION & STATE ***
        // const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzrTRUbmBsvq6zJw86qPuy_sN5xZbyrnptUb2ZbHpRNC8PtD5NQMhaHDiHEoRS1oEEu/exec'; // *** ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
        let currentTab = 'add';
        let transactionType = 'EXPENSE'; 
        const LOGGED_IN_USER_KEY = 'budgetAppUser'; 
        const LOGGED_IN_PASSCODE_KEY = 'budgetAppPasscode'; 

        // ‚úÖ NEW STATE
        let transactionsData = []; 
        let estimatesData = [];
        let logsData = [];
        let membersData = []; // ‚úÖ NEW
        let advanceData = []; // ‚úÖ NEW

        // *** 2. CORE UTILITY FUNCTIONS ***

        // Utility: Show stylish notification (Toast)
        function showNotification(message, type = 'info', duration = 3000) {
            const notif = document.getElementById('notification');
            notif.className = ''; 
            notif.classList.add(type, 'show');
            notif.textContent = message;
            notif.style.display = 'block';
            
            if (duration > 0 && duration !== 60000) { 
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => {
                        notif.style.display = 'none';
                    }, 500);
                }, duration);
            }
        }

        // Utility: Update current date/time display
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('th-TH', { 
                year: 'numeric', month: 'short', day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('th-TH', { 
                hour: '2-digit', minute: '2-digit' 
            });
            document.getElementById('current-datetime').textContent = `${dateStr} ${timeStr}`;
        }
        setInterval(updateDateTime, 1000); 
        updateDateTime(); 

        // Core API Call (Uses GET method for all data exchange)
async function postData(payload) {
    // ‚ö†Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏•‡∏∞ WEB_APP_URL ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
    
    document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => btn.disabled = true);
    showNotification('‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'info', 60000);

    return new Promise((resolve, reject) => {
        try {
            // ‡πÉ‡∏ä‡πâ google.script.run ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á Server (Code.gs)
            // ‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ doGet(payload) ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÄ‡∏≠‡∏á
            google.script.run
                .withSuccessHandler(resolve) // ‡∏´‡∏≤‡∏Å Server (Code.gs) ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                .withFailureHandler(reject)  // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Server
                .doGet(payload); // ‡∏™‡πà‡∏á Object payload ‡πÑ‡∏õ‡∏¢‡∏±‡∏á doGet ‡πÉ‡∏ô Code.gs
        } catch (e) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
            reject({ success: false, message: 'CRITICAL ERROR: Google Apps Script API (google.script.run) is not available.' });
        } finally {
            // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            document.querySelectorAll('.btn-primary, .btn-secondary').forEach(btn => btn.disabled = false);
            document.getElementById('notification').classList.remove('show', 'info');
            document.getElementById('notification').style.display = 'none';
        }
    });
}
        
        // *** 3. UI MANAGEMENT ***

        function showTab(tabName) {
            // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á Tabs ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.getElementById('add-tab').style.display = tabName === 'add' ? 'block' : 'none';
            document.getElementById('estimate-tab').style.display = tabName === 'estimate' ? 'block' : 'none';
            document.getElementById('members-tab').style.display = tabName === 'members' ? 'block' : 'none';
            document.getElementById('settlement-tab').style.display = tabName === 'settlement' ? 'block' : 'none';
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Active ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°
            document.querySelectorAll('.tab-buttons-main .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-buttons-main button[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            currentTab = tabName;
        }

        document.getElementById('btn-expense').addEventListener('click', function() {
            document.getElementById('btn-expense').classList.add('active');
            document.getElementById('btn-income').classList.remove('active');
            document.getElementById('payment-type-group').style.display = 'flex';
            document.getElementById('paid-by-group').style.display = 'flex';
            document.getElementById('income-member-group').style.display = 'none'; // ‚úÖ NEW: ‡∏ã‡πà‡∏≠‡∏ô Income Member
            transactionType = 'EXPENSE';
        });
        document.getElementById('btn-income').addEventListener('click', function() {
            document.getElementById('btn-income').classList.add('active');
            document.getElementById('btn-expense').classList.remove('active');
            document.getElementById('payment-type-group').style.display = 'none';
            document.getElementById('paid-by-group').style.display = 'none';
            document.getElementById('income-member-group').style.display = 'flex'; // ‚úÖ NEW: ‡πÅ‡∏™‡∏î‡∏á Income Member
            transactionType = 'INCOME';
        });
        
        // *** 4. LOGIN & AUTHENTICATION ***

        async function loadAccountName() {
            document.getElementById('account-name-display').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...'; 
            
            const payload = { action: 'LOGIN', passcode: '000000', user: 'System' };
            const result = await postData(payload); 

            if (result.success && result.accountName) {
                document.getElementById('account-name-display').innerHTML = `
                    <span>${result.accountName}</span>
                `;
                return true; 
            } else {
                document.getElementById('account-name-display').innerHTML = `
                    <span style="color: red;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏´‡∏•‡∏±‡∏Å: ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>
                `;
                showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`, 'error', 10000);
                return false; 
            }
        }

        async function checkAutoLogin() { 
            await loadAccountName(); 
            
            const storedUser = localStorage.getItem(LOGGED_IN_USER_KEY);
            const storedPasscode = localStorage.getItem(LOGGED_IN_PASSCODE_KEY);
            
            if (storedUser && storedPasscode) {
                document.getElementById('username').value = storedUser;
                document.getElementById('passcode').value = storedPasscode;
                
                const loginSuccess = await login(true); 
                
                if (!loginSuccess) {
                    document.getElementById('login-screen').style.display = 'block';
                    document.getElementById('app-screen').style.display = 'none';
                }
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('app-screen').style.display = 'none';
            }
        }
        
        async function login(isAuto = false) {
            const passcode = document.getElementById('passcode').value.trim();
            const user = document.getElementById('username').value.trim();
            
            if (!passcode || !user) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'info');
                return false;
            }

            const loginBtn = document.getElementById('login-btn');
            loginBtn.disabled = true;

            const payload = { action: 'LOGIN', passcode: passcode, user: user, isAuto: isAuto }; 
            const result = await postData(payload);

            loginBtn.disabled = false; 

            if (result.success) {
                localStorage.setItem(LOGGED_IN_USER_KEY, user);
                localStorage.setItem(LOGGED_IN_PASSCODE_KEY, passcode);
                
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                
                document.getElementById('account-name-display').innerHTML = `
                    <span>${result.accountName}</span>
                    <span id="user-greeting-display">Make by K-mew, ‡∏Ñ‡∏∏‡∏ì ${result.user}</span>
                `;
                document.getElementById('logout-btn').style.display = 'inline';
                
                showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                setTimeout(loadAllData, 100); 
                return true;

            } else {
                showNotification(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`, 'error');
                
                if (isAuto) {
                    localStorage.removeItem(LOGGED_IN_USER_KEY);
                    localStorage.removeItem(LOGGED_IN_PASSCODE_KEY);
                    await loadAccountName();
                    document.getElementById('login-screen').style.display = 'block';
                    document.getElementById('app-screen').style.display = 'none';
                }
                return false;
            }
        }

        async function logout() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            await postData({ action: 'LOGOUT', user: user });
            
            localStorage.removeItem(LOGGED_IN_USER_KEY);
            localStorage.removeItem(LOGGED_IN_PASSCODE_KEY);
            
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            
            await loadAccountName(); 
            
            showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        document.getElementById('logout-btn').addEventListener('click', logout);

        // *** 5. DATA ACTIONS ***
        
        async function addTransaction() {
            const description = document.getElementById('transaction-description').value.trim();
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);

            if (!description || isNaN(amount) || amount <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'info');
                return;
            }
            
            let paidBy = null;
            let paymentType = null;
            let incomeMember = null; // ‚úÖ NEW
            
            if (transactionType === 'EXPENSE') {
                paidBy = document.getElementById('paid-by-member').value;
                paymentType = document.querySelector('input[name="payment-type"]:checked').value;

                if (!paidBy) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô (Paid By)"', 'info');
                    return;
                }
            } else if (transactionType === 'INCOME') { // ‚úÖ NEW LOGIC FOR INCOME
                incomeMember = document.getElementById('income-member').value || '-'; // ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô '-' (Sponsor)
            }


    const payload = { 
        action: 'ADD_TRANSACTION', 
        user: user, 
        type: transactionType, 
        description: description, 
        amount: amount,
        paidBy: paidBy,
        paymentType: paymentType,
        incomeMember: incomeMember // ‚úÖ NEW
    };
            
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                document.getElementById('transaction-description').value = '';
                document.getElementById('transaction-amount').value = '';
            } else {
                showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }
        
        async function addEstimate() {
            const description = document.getElementById('estimate-description').value.trim();
            const amount = parseFloat(document.getElementById('estimate-amount').value);
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);

            if (!description || isNaN(amount) || amount <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'info');
                return;
            }

            const payload = { 
                action: 'ADD_ESTIMATE', user: user, description: description, amount: amount
            };
            
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                document.getElementById('estimate-description').value = '';
                document.getElementById('estimate-amount').value = '';
            } else {
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }
        
        async function addMember() {
            const memberName = document.getElementById('new-member-name').value.trim();
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);

            if (!memberName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'info');
                return;
            }
            
            const payload = { action: 'ADD_MEMBER', user: user, memberName: memberName };
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                document.getElementById('new-member-name').value = '';
            } else {
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        async function addAdvanceDraw() {
            const memberName = document.getElementById('advance-member').value;
            const amount = parseFloat(document.getElementById('advance-amount').value);
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            if (!memberName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', 'info');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'info');
                return;
            }

            const payload = { action: 'ADD_ADVANCE', user: user, memberName: memberName, amount: amount };
            const result = await postData(payload);

            if (result.success) {
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                document.getElementById('advance-amount').value = '';
                document.getElementById('advance-member').selectedIndex = 0; // Reset Dropdown
            } else {
                showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        // *** 6. DATA DISPLAY ***
        
        async function loadAllData() {
            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info', 60000); 
            const payload = { action: 'GET_DATA' };
            const result = await postData(payload);

            if (result.success) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
                transactionsData = result.transactions;
                estimatesData = result.estimates;
                logsData = result.logs;
                membersData = result.members || []; // ‚úÖ NEW
                advanceData = result.advance || []; // ‚úÖ NEW

                // ‚úÖ NEW: ‡πÇ‡∏´‡∏•‡∏î Settlement Data
                const settlementResult = await postData({ action: 'GET_SETTLEMENT_DATA' });
                if (settlementResult.success) {
                    renderSettlement(settlementResult.settlementData); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                }
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                renderOverview(result); 
                renderTransactionData(transactionsData); 
                renderEstimateData(estimatesData);
                renderLogs(logsData); 
                renderMembers(membersData); // ‚úÖ NEW
                renderAdvance(advanceData); // ‚úÖ NEW

                showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        // ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå poolvilla2.html (‡∏™‡πà‡∏ß‡∏ô JavaScript)

function renderSettlement(data) {
    const container = document.getElementById('settlement-summary');
    const poolNetBalance = data.poolNetBalance || 0; // ‚úÖ NEW: ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î Pool Balance
    const settlementData = data.settlementData;
    let html = '';
    
    // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
    const membersList = Object.keys(settlementData).map(name => ({
        name: name,
        data: settlementData[name]
    }));
    
    if (membersList.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #888;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô Tab ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å/‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡πà‡∏≠‡∏ô</p>';
        return;
    }

    // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (Pool Status)
    const poolClass = poolNetBalance >= 0 ? 'text-success' : 'text-danger';
    html += `
        <h3 style="margin-top: 5px;">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (Pool)</h3>
        <div style="text-align: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 1.1em;">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° - ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Pool)</p>
            <strong style="font-size: 1.8em;" class="${poolClass}">
                ${poolNetBalance.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
            </strong>
            <p style="font-size: 0.8em; color: #6c757d; margin: 5px 0 0;">
                (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ß‡∏Å: ‡∏à‡∏∞‡∏´‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö: ‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)
            </p>
        </div>
    `;

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
    html += `
        <h3 style="margin-top: 15px;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÇ‡∏≠‡∏ô)</h3>
        <table class="transaction-table">
            <thead>
                <tr>
                    <th style="width: 20%;">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                    <th style="width: 30%; text-align: right;">‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï)</th>
                    <th style="width: 30%; text-align: right;">‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°/‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</th>
                    <th style="width: 20%; text-align: right;">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    membersList.forEach(m => {
        const d = m.data;
        const netBalance = d.netBalance;
        const balanceClass = netBalance > 0 ? 'text-danger' : (netBalance < 0 ? 'text-success' : '');
        const netText = netBalance > 0 ? `${Math.abs(netBalance).toLocaleString('th-TH', { minimumFractionDigits: 2 })}` : (netBalance < 0 ? `${Math.abs(netBalance).toLocaleString('th-TH', { minimumFractionDigits: 2 })}` : '0.00');

        html += `
            <tr>
                <td><strong>${m.name}</strong></td>
                <td class="text-success" style="text-align: right;">${d.paidOut.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                <td class="text-danger" style="text-align: right;">${(d.advanceDebt + d.baseDebit).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</td>
                <td class="${balanceClass}" style="font-weight: bold; text-align: right;">
                    ${netBalance > 0 ? '‡∏à‡πà‡∏≤‡∏¢: ' : (netBalance < 0 ? '‡∏£‡∏±‡∏ö: ' : '')}
                    ${netText}
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå (Settlement)
    const creditors = membersList.filter(m => m.data.netBalance < 0).sort((a, b) => a.data.netBalance - b.data.netBalance); 
    const debtors = membersList.filter(m => m.data.netBalance > 0).sort((a, b) => b.data.netBalance - a.data.netBalance); 
    
    let transferHtml = '<h3 style="margin-top: 20px;">‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡∏µ‡πâ (‡πÉ‡∏Ñ‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£)</h3>';
    let transfers = [];

    // Core Settlement Logic (Simplified) - **Same as V2, but uses the new netBalance**
    let currentDebtors = debtors.map(d => ({ name: d.name, amount: d.data.netBalance }));
    let currentCreditors = creditors.map(c => ({ name: c.name, amount: Math.abs(c.data.netBalance) }));

    let i = 0; 
    let j = 0;

    while (i < currentDebtors.length && j < currentCreditors.length) {
        const debtor = currentDebtors[i];
        const creditor = currentCreditors[j];

        const transferAmount = Math.min(debtor.amount, creditor.amount);

        if (transferAmount > 0.01) { 
            transfers.push({
                from: debtor.name,
                to: creditor.name,
                amount: transferAmount
            });

            debtor.amount -= transferAmount;
            creditor.amount -= transferAmount;
        }

        if (debtor.amount <= 0.01) { 
            i++;
        }
        if (creditor.amount <= 0.01) { 
            j++;
        }
    }
    
    if (transfers.length > 0) {
        transferHtml += `
            <ul style="list-style-type: none; padding: 0;">
                ${transfers.map(t => 
                    `<li style="padding: 8px 0; border-bottom: 1px dashed #ddd; font-weight: bold;">
                        ${t.from} (‡∏à‡πà‡∏≤‡∏¢) ‚û°Ô∏è ${t.to} (‡∏£‡∏±‡∏ö): 
                        <span class="text-danger">${t.amount.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</span> ‡∏ö‡∏≤‡∏ó
                    </li>`).join('')}
            </ul>
        `;
    } else {
        transferHtml += '<p style="text-align: center; color: #28a745; font-weight: bold;">ü•≥ ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>';
    }

    container.innerHTML = html + transferHtml;
}

// ... (‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á poolvilla2.html ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)

        // Utility ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Populating Dropdowns
function populateMemberDropdowns(members) {
    const dropdowns = [
        document.getElementById('paid-by-member'),
        document.getElementById('advance-member'),
        document.getElementById('income-member') // ‚úÖ NEW
    ];

    dropdowns.forEach(select => {
        const selectedValue = select.value;
        // ‡∏õ‡∏£‡∏±‡∏ö option ‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Income ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        if (select.id === 'income-member') {
            select.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (Sponsor/‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡∏£‡∏ß‡∏°) --</option>'; 
        } else {
            select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å --</option>'; 
        }
        
        members.forEach(member => {
            const option = document.createElement('option');
            option.value = member;
            option.textContent = member;
            if (member === selectedValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    });
}
        
        function renderMembers(members) {
            const listElement = document.getElementById('member-list-container');
            const memberCountElement = document.getElementById('member-count');
            memberCountElement.textContent = members.length;
            
            listElement.innerHTML = `
                <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${members.length} ‡∏Ñ‡∏ô)</h3>
                <ul style="list-style-type: none; padding: 0;">
                ${members.map(m => `<li style="padding: 5px 0; border-bottom: 1px dotted #eee;">${m}</li>`).join('')}
                </ul>
            `;
            
            // ‚úÖ NEW: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            populateMemberDropdowns(members);
        }

        function renderAdvance(advance) {
            const listElement = document.getElementById('advance-list-container');
            listElement.innerHTML = '<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</h3>'; 

            if (!advance || advance.length === 0) {
                listElement.innerHTML += '<p style="text-align: center; color: #888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</p>';
                return;
            }
            
            let totalAdvanceDebt = 0;
            const latestAdvance = advance.slice().reverse().slice(0, 10);

            let html = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th style="width: 30%; text-align: right;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th style="width: 20%; text-align: center;">‡πÇ‡∏î‡∏¢</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            latestAdvance.forEach(a => {
                const amount = parseFloat(a.Amount) || 0;
                totalAdvanceDebt += amount;
                
                html += `
                    <tr>
                        <td>
                            ${a.MemberName} 
                            <div style="font-size: 0.7em; color: #888;">${a.Timestamp}</div>
                        </td>
                        <td class="text-danger">
                            ${amount.toLocaleString('th-TH', { minimumFractionDigits: 2 })}
                        </td>
                        <td style="text-align: center;">${a.User}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <p style="font-weight: bold; text-align: right; margin-top: 10px;">‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏ß‡∏°: <span class="text-danger">${totalAdvanceDebt.toLocaleString('th-TH', { minimumFractionDigits: 2 })}</span> ‡∏ö‡∏≤‡∏ó</p>
            `;
            
            listElement.innerHTML = html;
        }

        function renderTransactionData(transactions) {
            const listElement = document.querySelector('#transactions-table tbody'); 
            listElement.innerHTML = ''; 

            if (!transactions || transactions.length === 0) {
                listElement.innerHTML = '<tr><td colspan="3" class="no-data">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö-‡∏à‡πà‡∏≤‡∏¢</td></tr>';
                return;
            }
            
            const latestTransactions = transactions.slice().reverse().slice(0, 10);

            latestTransactions.forEach((t) => {
                const typeClass = t.Type === 'INCOME' ? 'income-row' : 'expense-row';
                const typeTextClass = t.Type === 'INCOME' ? 'text-success' : 'text-danger';
                
                let typeLabel = t.Type === 'INCOME' ? '‡∏£‡∏±‡∏ö' : '‡∏à‡πà‡∏≤‡∏¢';
                let paidByDetail = t.PaidBy && t.PaidBy !== '-' ? `(‡πÇ‡∏î‡∏¢ ${t.PaidBy})` : '';
                
                if (t.PaymentType && t.PaymentType !== 'INCOME') {
                    typeLabel += ` (${t.PaymentType.substring(0, 1)})`; // P, A, E
                }


                const amount = (parseFloat(t.Amount) || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });
                
                const row = document.createElement('tr');
                row.className = `${typeClass}`; 

                row.innerHTML = `
                    <td>
                        ${t.Description || '-'} 
                        <div style="font-size: 0.7em; color: #888;">${t.Timestamp} | ${paidByDetail}</div>
                    </td>
                    <td class="${typeTextClass}">
                        ${typeLabel}<br>
                        ${amount}
                    </td>
                    <td style="text-align: center;">
                        <button onclick="deleteTransaction('${t.Type}', ${t['Data Index']})" class="delete-btn">‡∏•‡∏ö</button>
                    </td>
                `;
                listElement.appendChild(row);
            });
        }

        function renderEstimateData(estimates) {
             let html = '';
            
            let totalEstimate = 0;
            
            if (estimates.length > 0) {
                 html += `<table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th style="width: 25%; text-align: right;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th>
                                    <th style="width: 35%; text-align: center;"></th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                estimates.forEach((row, index) => {
                    const amount = parseFloat(row.Amount);
                    totalEstimate += amount;

                    html += `
                        <tr>
                            <td>${row.Description}</td>
                            <td style="text-align: right;">${amount.toLocaleString('th-TH')}</td>
                            <td style="text-align: center;">
                                <button class="btn-primary btn-login" style="padding: 5px 8px; font-size: 0.8em; width: auto; margin: 2px;" onclick="forwardEstimate(${index})">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</button>
                                <button class="btn-secondary" style="padding: 5px 8px; font-size: 0.8em; width: auto; margin: 2px;" onclick="deleteEstimate(${index})">‡∏•‡∏ö</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
            } else {
                 html += `<p style="text-align: center; color: #888;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>`;
            }
            
            // ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const listSection = document.getElementById('estimate-list-container');
            listSection.innerHTML = html;
            
            document.getElementById('total-estimate-display').textContent = totalEstimate.toLocaleString('th-TH', { 
                minimumFractionDigits: 2, maximumFractionDigits: 2 
            });
        }
        
        function renderLogs(logs) { 
            const logElement = document.getElementById('log-display');
            if (logs && logs.length > 0) { 
                const latestLogs = logs.slice(-10).reverse();
                logElement.textContent = latestLogs.map(log => 
                    `[${log.Timestamp}] ${log.User}: ${log.Action}`
                ).join('\n');
            } else {
                logElement.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
            }
        }
        
        function renderOverview(result) {
            // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î Budget
            const totalIncome = parseFloat(result.totalBudget) || 0;
            document.getElementById('total-budget-amount').textContent = totalIncome.toLocaleString('th-TH', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            });
            
            // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (Available Balance)
            const availableBalanceAmount = parseFloat(result.availableBalance) || 0;
            const totalEstimateAmount = parseFloat(result.totalEstimate) || 0; 
            
            const balanceElement = document.getElementById('balance-display');
            const balanceClass = availableBalanceAmount >= 0 ? 'balance-positive' : 'balance-negative';
            
            balanceElement.innerHTML = `
                ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á): 
                <div class="${balanceClass}">
                    ${availableBalanceAmount.toLocaleString('th-TH', { 
                        minimumFractionDigits: 2, 
                        maximumFractionDigits: 2 
                    })} ‡∏ö‡∏≤‡∏ó
                </div>`;

            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°
            const estimateDisplayElement = document.getElementById('estimate-total-display');
            if (estimateDisplayElement) {
                if (totalEstimateAmount > 0) {
                    estimateDisplayElement.style.display = 'block';
                    estimateDisplayElement.innerHTML = `
                        ‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°: 
                        <span class="estimate-amount">${totalEstimateAmount.toLocaleString('th-TH', { 
                            minimumFractionDigits: 2, 
                            maximumFractionDigits: 2 
                        })} ‡∏ö‡∏≤‡∏ó</span>
                    `;
                } else {
                    estimateDisplayElement.style.display = 'none'; 
                }
            }


            // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const visitorCount = parseInt(result.visitorCount) || 0;
            let visitorDetail = '';
            
            if (result.visitors && result.visitors.length > 0) {
                const uniqueUsers = [...new Set(result.visitors
                    .map(v => v.User.toString().trim())
                    .filter(u => u !== 'System_Check' && u !== 'System'))
                ];
                
                if (uniqueUsers.length > 0) {
                    visitorDetail = `<br><span style="font-size: 0.6em; font-weight: normal; color: #6c757d;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡πÇ‡∏î‡∏¢: ${uniqueUsers.join(', ')}</span>`;
                }
            }

            const visitorElement = document.getElementById('visitor-count'); 
            visitorElement.innerHTML = `${visitorCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á${visitorDetail}`;
        }
        
        // Delete Transaction
        async function deleteTransaction(type, dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${type} ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_TRANSACTION',
                user: user,
                rowIndex: dataIndex 
            };

            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }
        
        // Delete Estimate
        async function deleteEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        // Forward Estimate to Transaction
        async function forwardEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'FORWARD_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á...', 'info', 60000); 
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } else {
                showNotification(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        // Initialize on load
        window.onload = checkAutoLogin;
    </script>
</body>
</html>







