<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Villa Budget App</title>
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* HEADER & STATUS BAR */
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        .status-bar {
            display: flex;
            align-items: center;
            font-size: 0.85em;
        }

        .user-status {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .user-status span {
            margin-left: 5px;
            font-weight: bold;
        }

        .balance-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.2em;
            font-weight: 700;
            color: #28a745; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
        }

        .negative {
            color: #dc3545; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏•‡∏ö */
        }

        .sub-balance-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.8em;
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            background-color: #eee;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #fff;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 10px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        select {
            appearance: none;
            background: #fff url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%20197.8L151.2%2062.2a14.3%2014.3%200%200%200-20.1%200L5.3%20197.8c-7.1%207.1-7.1%2018.6%200%2025.7s18.6%207.1%2025.7%200l113.8-113.8L261.3%20223.5c7.1%207.1%2018.6%207.1%2025.7%200s7.1-18.6%200-25.7z%22%2F%3E%3C%2Fsvg%3E') no-repeat right 10px center;
            background-size: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            margin-top: 10px;
        }
        
        .btn-danger:hover {
            background-color: #b02a37;
        }

        /* DATA LISTS (TRANSACTIONS & ESTIMATES) */
        .data-list {
            margin-top: 15px;
        }

        .data-item {
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-description {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 3px;
        }

        .item-meta {
            font-size: 0.85em;
            color: #6c757d;
        }

        .item-amount {
            font-weight: 700;
            font-size: 1.2em;
            margin-left: 10px;
        }

        .income {
            color: #28a745;
        }

        .expense {
            color: #dc3545;
        }
        
        .estimate-item {
            border-left: 5px solid #ffc107; /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô */
        }
        
        .estimate .item-amount {
            color: #ffc107;
        }

        .data-list h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .delete-btn, .forward-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            padding: 0;
            width: auto;
            transition: color 0.2s;
        }
        
        .forward-btn {
            color: #007bff;
        }

        .delete-btn:hover, .forward-btn:hover {
            color: #000;
        }
        
        /* LOGIN PAGE */
        .login-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-form {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 350px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #007bff;
        }

        /* NOTIFICATION */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            color: white;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification-bar.show {
            display: block;
            opacity: 1;
        }

        .notification-bar.success {
            background-color: #28a745;
        }

        .notification-bar.error {
            background-color: #dc3545;
        }

        .notification-bar.info {
            background-color: #ffc107;
            color: #333;
        }
        
        /* SETTLEMENT TABLE */
        .settlement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .settlement-table th, .settlement-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        
        .settlement-table th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .settlement-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .settlement-table .net-balance-cell {
            font-weight: bold;
        }
        
        .settlement-table .credit {
            color: #28a745;
        }
        
        .settlement-table .debt {
            color: #dc3545;
        }

        /* MOBILE OPTIMIZATION */
        @media (min-width: 601px) {
            .container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body>

    <div class="notification-bar" id="notificationBar"></div>

    <div id="mainApp" style="display: none;">
        <header>
            <h1 id="accountNameTitle">Pool Villa Budget App</h1>
            <div class="status-bar">
                <div class="user-status">
                    üßë <span id="loggedInUser"></span>
                </div>
                <button onclick="logout()" style="background-color: transparent; color: white; border: 1px solid white; padding: 5px 10px; font-size: 0.8em; margin-left: 10px; width: auto;">
                    Logout
                </button>
            </div>
        </header>
        
        <div class="container">
            <div id="balanceBox" class="balance-box">
                <div class="balance-title">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)</div>
                <div id="availableBalance" class="balance-amount">0.00</div>
                <div class="sub-balance-info">
                    <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: <span id="currentBalance">0.00</span></span>
                    <span>‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: <span id="totalEstimate">0.00</span></span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'AddTransaction')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="tab-button" onclick="openTab(event, 'ViewData')">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                <button class="tab-button" onclick="openTab(event, 'Settlement')">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                <button class="tab-button" onclick="openTab(event, 'Advanced')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
            </div>

            <div id="AddTransaction" class="tab-content active">
                <div class="form-group">
                    <label for="transactionType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <select id="transactionType" onchange="toggleIncomeExpenseFields()">
                        <option value="EXPENSE">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="INCOME">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                    </select>
                </div>
                
                <div id="expenseFields">
                    <div class="form-group">
                        <label for="expensePaidBy">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (Credit)</label>
                        <select id="expensePaidBy" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</label>
                        <select id="paymentType" required>
                            <option value="POOL">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (Pool)</option>
                            <option value="INDIVIDUAL">‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏´‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</option>
                        </select>
                    </div>
                </div>
                
                <div id="incomeFields" style="display:none;">
                    <div class="form-group">
                        <label for="incomeMember">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</label>
                        <select id="incomeMember">
                            <option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô Sponsor (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï) --</option>
                            </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transactionAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionDescription">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <input type="text" id="transactionDescription" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏Ø‡∏•‡∏Ø" required>
                </div>
                <button class="btn-primary" onclick="addTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

                <h3 style="margin-top: 30px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Estimate)</h3>
                <p style="font-size: 0.9em; color: #666;">‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</p>
                <div class="form-group">
                    <label for="estimateAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ</label>
                    <input type="number" id="estimateAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="estimateDescription">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                    <input type="text" id="estimateDescription" placeholder="‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á">
                </div>
                <button class="btn-primary" onclick="addEstimate()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
            </div>

            <div id="ViewData" class="tab-content">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div id="transactionList" class="data-list">
                </div>
                
                <h3 style="margin-top: 30px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</h3>
                <div id="estimateList" class="data-list">
                </div>
            </div>

            <div id="Settlement" class="tab-content">
                <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <p style="font-size: 0.9em; color: #666;">‡∏¢‡∏≠‡∏î‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∑‡∏≠ **‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô)**, ‡∏¢‡∏≠‡∏î‡∏•‡∏ö‡∏Ñ‡∏∑‡∏≠ **‡∏´‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°)**</p>
                <table id="settlementTable" class="settlement-table">
                    <thead>
                        <tr>
                            <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (Credit)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Debit)</th>
                            <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å (Advance Debt)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <h3 style="margin-top: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Advance)</h3>
                <div id="advanceList" class="data-list">
                </div>
            </div>

            <div id="Advanced" class="tab-content">
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="form-group">
                    <label for="newMemberName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                    <input type="text" id="newMemberName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
                </div>
                <button class="btn-primary" onclick="addMember()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>

                <h3 style="margin-top: 30px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Advance)</h3>
                <div class="form-group">
                    <label for="advanceMember">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <select id="advanceMember" required>
                    </select>
                </div>
                <div class="form-group">
                    <label for="advanceAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <input type="number" id="advanceAmount" placeholder="0.00" step="0.01" required>
                </div>
                <button class="btn-primary" onclick="addAdvance()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>

                <button class="btn-danger" style="margin-top: 50px;" onclick="clearActiveUsers()">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)</button>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>Pool Villa Budget App</h2>
            <div class="form-group">
                <label for="loginUser">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                <input type="text" id="loginUser" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ Admin" required>
            </div>
             <div class="form-group">
                <label for="passcode">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="passcode" placeholder="‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" required>
            </div>
            <button class="btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>
    <script>
        // *** 1. CONFIGURATION & STATE ***
        const LOGGED_IN_USER_KEY = 'poolVillaBudgetAppUser';
        let allMembers = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let currentData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Apps Script

        // *** 2. CORE APIS ***
        // Core API Call (Uses GET method for all data exchange)
        function postData(payload) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(result => {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô Server (Code.gs) ‡∏à‡∏∞‡∏™‡πà‡∏á success: false ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                        if (result && result.success === false) {
                            reject(result.message || 'Server returned failure.');
                            return;
                        }
                        resolve(result);
                    })
                    .withFailureHandler(error => {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô Script function not found)
                        console.error('Apps Script Call Failed:', error);
                        // Check for deployment error pattern (common in Apps Script errors)
                         if (error.includes('No deployment found')) {
                            reject('No deployment found for this ID. Please re-deploy the web app.');
                        } else {
                            reject(error);
                        }
                    })
                    .doGet(payload); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å doGet ‡πÉ‡∏ô Code.gs
            });
        }

        // --- DATA RETRIEVAL ---
        async function loadAllData() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Transactions, Estimates, Balances)
                const payload = { action: 'GET_DATA' };
                const result = await postData(payload);

                if (result.success) {
                    currentData = result;
                    allMembers = result.members || [];
                    
                    renderBalance(result.poolBalance, result.availableBalance, result.totalEstimate);
                    renderTransactionList(result.transactions);
                    renderEstimateList(result.estimates);
                    renderSettlement(result.settlement);
                    renderAdvanceList(result.advance);
                    
                    // Populate member selects
                    populateMemberSelects();
                    
                } else {
                    showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error', 5000);
                }
            } catch (e) {
                console.error("Load Data Error:", e);
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${e}`, 'error', 5000);
            }
        }
        
        // --- LOGIN & LOGOUT (MODIFIED) ---
        async function login() {
            const user = document.getElementById('loginUser').value.trim();
            const passcode = document.getElementById('passcode').value.trim(); // Get passcode
            
            if (!user) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'error');
                return;
            }

            try {
                const payload = {
                    action: 'LOGIN',
                    user: user,
                    passcode: passcode // Send passcode to the server
                };

                const result = await postData(payload);

                if (result.success) {
                    localStorage.setItem(LOGGED_IN_USER_KEY, user);
                    showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    // Hide login screen, show app
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                    document.getElementById('loggedInUser').textContent = user;
                    // Reset passcode field
                    document.getElementById('passcode').value = ''; 
                    await loadAllData();
                } else {
                    showNotification(result.message || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
                }
            } catch (e) {
                console.error("Login Error:", e);
                 if (e.includes('No deployment found')) {
                    showNotification('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ App Script. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Deploy', 'error', 10000);
                } else {
                    showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${e}`, 'error');
                }
            }
        }

        function logout() {
            localStorage.removeItem(LOGGED_IN_USER_KEY);
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loggedInUser').textContent = '';
            showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
        }

        function checkAutoLogin() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            if (user) {
                // Simulate successful login if session exists
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                document.getElementById('loggedInUser').textContent = user;
                loadAllData();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        }
        // *** 3. RENDER FUNCTIONS ***
        function formatNumber(num) {
            if (typeof num !== 'number') return '0.00';
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function renderBalance(poolBalance, availableBalance, totalEstimate) {
            const balanceElement = document.getElementById('availableBalance');
            const currentBalanceElement = document.getElementById('currentBalance');
            const totalEstimateElement = document.getElementById('totalEstimate');

            balanceElement.textContent = formatNumber(availableBalance);
            currentBalanceElement.textContent = formatNumber(poolBalance);
            totalEstimateElement.textContent = formatNumber(totalEstimate);
            
            // Apply color to the main available balance
            if (availableBalance < 0) {
                balanceElement.classList.add('negative');
            } else {
                balanceElement.classList.remove('negative');
            }
        }
        
        function populateMemberSelects() {
            const selects = [
                document.getElementById('expensePaidBy'),
                document.getElementById('incomeMember'),
                document.getElementById('advanceMember')
            ];
            
            selects.forEach(select => {
                const isIncome = select.id === 'incomeMember';
                const originalOptions = Array.from(select.options).filter(opt => opt.value === '' && isIncome);
                
                // Clear existing options, but keep the special income option
                select.innerHTML = '';
                if (isIncome && originalOptions.length > 0) {
                    select.appendChild(originalOptions[0]);
                }

                allMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                });
            });
        }
        
        function renderTransactionList(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            
            if (!transactions || transactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</p>';
                return;
            }

            transactions.slice().reverse().forEach((t, originalIndex) => {
                // The actual row index in the sheet (0-based array index of the data, NOT including header)
                // We use the reversed array index to get the actual index in the sheet data.
                const dataIndex = transactions.length - 1 - originalIndex;
                const isExpense = t.Type === 'EXPENSE';
                const amountClass = isExpense ? 'expense' : 'income';
                
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${t.Description}</div>
                        <div class="item-meta">
                            ${t.Timestamp ? new Date(t.Timestamp).toLocaleDateString('th-TH') : ''} | 
                            ${isExpense ? `‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${t['Paid By']} (${t['Payment Type'] === 'POOL' ? '‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á' : '‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß'})` : `‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å: ${t.Member || 'SPONSOR'}`}
                        </div>
                    </div>
                    <div class="item-amount ${amountClass}">
                        ${isExpense ? '-' : '+'} ${formatNumber(t.Amount)}
                    </div>
                    <button class="delete-btn" onclick="deleteTransaction(${dataIndex})" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
        }

        function renderEstimateList(estimates) {
            const list = document.getElementById('estimateList');
            list.innerHTML = '';

            if (!estimates || estimates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</p>';
                return;
            }
            
            estimates.slice().reverse().forEach((e, originalIndex) => {
                 // The actual row index in the sheet (0-based array index of the data, NOT including header)
                const dataIndex = estimates.length - 1 - originalIndex;
                
                const item = document.createElement('div');
                item.className = 'data-item estimate-item';
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${e.Description}</div>
                        <div class="item-meta">
                            ${e.Timestamp ? new Date(e.Timestamp).toLocaleDateString('th-TH') : ''} | 
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${e['Logged By']}
                        </div>
                    </div>
                    <div class="item-amount estimate">
                        -${formatNumber(e.Amount)}
                    </div>
                    <button class="forward-btn" onclick="forwardEstimate(${dataIndex})" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á">‚û°Ô∏è</button>
                    <button class="delete-btn" onclick="deleteEstimate(${dataIndex})" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
        }
        
        function renderAdvanceList(advances) {
             const list = document.getElementById('advanceList');
            list.innerHTML = '';

            if (!advances || advances.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</p>';
                return;
            }
            
            advances.slice().reverse().forEach((a, originalIndex) => {
                const item = document.createElement('div');
                item.className = 'data-item estimate-item'; // Use estimate style for visibility
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢ ${a.Member}</div>
                        <div class="item-meta">
                            ${a.Timestamp ? new Date(a.Timestamp).toLocaleDateString('th-TH') : ''} | 
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢: ${a['Logged By']}
                        </div>
                    </div>
                    <div class="item-amount expense">
                        -${formatNumber(a.Amount)}
                    </div>
                    `;
                list.appendChild(item);
            });
        }

        function renderSettlement(settlementData) {
            const tbody = document.getElementById('settlementTable').querySelector('tbody');
            tbody.innerHTML = '';

            if (!settlementData || settlementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</td></tr>';
                return;
            }

            settlementData.forEach(s => {
                const netClass = s.netBalance >= 0 ? 'credit' : 'debt';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${s.member}</td>
                    <td>${formatNumber(s.paidOut)}</td>
                    <td>${formatNumber(s.baseDebit)}</td>
                    <td>${formatNumber(s.advanceDebt)}</td>
                    <td class="net-balance-cell ${netClass}">${formatNumber(s.netBalance)}</td>
                `;
                tbody.appendChild(row);
            });
        }


        // *** 4. ACTION FUNCTIONS ***
        function toggleIncomeExpenseFields() {
            const type = document.getElementById('transactionType').value;
            document.getElementById('expenseFields').style.display = type === 'EXPENSE' ? 'block' : 'none';
            document.getElementById('incomeFields').style.display = type === 'INCOME' ? 'block' : 'none';
        }
        
        async function addTransaction() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const type = document.getElementById('transactionType').value;
            const amount = document.getElementById('transactionAmount').value;
            const description = document.getElementById('transactionDescription').value.trim();
            
            if (!user || !amount || !description) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            let payload = {
                action: 'ADD_TRANSACTION',
                user: user,
                type: type,
                amount: amount,
                description: description
            };

            if (type === 'EXPENSE') {
                const paidBy = document.getElementById('expensePaidBy').value;
                const paymentType = document.getElementById('paymentType').value;
                if (!paidBy) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                    return;
                }
                payload.paidBy = paidBy;
                payload.paymentType = paymentType;
            } else if (type === 'INCOME') {
                const member = document.getElementById('incomeMember').value;
                payload.member = member;
            }

            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    // Clear fields
                    document.getElementById('transactionAmount').value = '';
                    document.getElementById('transactionDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        async function addEstimate() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const amount = document.getElementById('estimateAmount').value;
            const description = document.getElementById('estimateDescription').value.trim();

            if (!user || !amount || !description) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_ESTIMATE',
                user: user,
                amount: amount,
                description: description
            };

            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    // Clear fields
                    document.getElementById('estimateAmount').value = '';
                    document.getElementById('estimateDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }

        async function addMember() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const newMemberName = document.getElementById('newMemberName').value.trim();

            if (!user || !newMemberName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà', 'error');
                return;
            }

            const payload = { 
                action: 'ADD_MEMBER',
                user: user,
                description: newMemberName // Using description field for simplicity
            };

            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('newMemberName').value = '';
                    await loadAllData(); // Reload data to update member lists
                } else {
                    showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        async function addAdvance() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const advanceMember = document.getElementById('advanceMember').value;
            const advanceAmount = document.getElementById('advanceAmount').value;

            if (!user || !advanceMember || !advanceAmount) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                return;
            }

            const payload = { 
                action: 'ADD_ADVANCE',
                user: user,
                member: advanceMember, 
                amount: advanceAmount
            };

            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('advanceAmount').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        async function clearActiveUsers() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô')) return;

             const user = localStorage.getItem(LOGGED_IN_USER_KEY);
             if (!user) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô', 'error');
                return;
            }

            const payload = { 
                action: 'CLEAR_ACTIVE_USERS',
                user: user
            };

            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification(result.message, 'success', 5000);
                } else {
                    showNotification(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        // --- DELETE & FORWARD ACTIONS ---
        
        // Delete Transaction
        async function deleteTransaction(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_TRANSACTION',
                user: user,
                rowIndex: dataIndex 
            };

            try {
                const result = await postData(payload);
                
                if (result.success) {
                    showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await loadAllData();
                } else {
                    showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        // Delete Estimate
        async function deleteEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            try {
                const result = await postData(payload);
                
                if (result.success) {
                    showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await loadAllData();
                } else {
                    showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }

        // Forward Estimate to Transaction
        async function forwardEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 1} ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'FORWARD_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á...', 'info', 60000); 
            
            try {
                const result = await postData(payload);
                
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await loadAllData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                } else {
                    showNotification(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (e) {
                showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e}`, 'error');
            }
        }
        
        // --- UI FUNCTIONS ---
        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Reload data if needed for the tab
            if (tabName === 'Settlement' || tabName === 'ViewData') {
                loadAllData();
            }
            if (tabName === 'AddTransaction') {
                toggleIncomeExpenseFields();
            }
        }

        function showNotification(message, type, duration = 3000) {
            const bar = document.getElementById('notificationBar');
            
            // Clear previous classes
            bar.className = 'notification-bar';
            
            bar.textContent = message;
            bar.classList.add(type);
            
            // Ensure it's displayed
            requestAnimationFrame(() => {
                bar.classList.add('show');
            });
            
            if (duration > 0) {
                setTimeout(() => {
                    bar.classList.remove('show');
                }, duration);
            }
        }
        
        // Initialize on load
        window.onload = checkAutoLogin;
    </script>
</body>
</html>
