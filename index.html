<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Villa Budget App</title>
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px; /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* HEADER & STATUS BAR */
        header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            font-size: 1.2em;
            margin: 0;
        }

        .status-bar {
            display: flex;
            align-items: center;
            font-size: 0.85em;
        }

        .user-status {
            margin-right: 15px;
            display: flex;
            align-items: center;
        }

        .user-status span {
            margin-left: 5px;
            font-weight: bold;
        }

        .balance-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .balance-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.2em;
            font-weight: 700;
            color: #28a745; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
        }

        .negative {
            color: #dc3545; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏•‡∏ö */
        }

        .sub-balance-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.8em;
            color: #555;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        /* TABS */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            background-color: #eee;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: #fff;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 10px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], 
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        select {
            appearance: none;
            background: #fff url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%20197.8L151.2%2062.2a14.3%2014.3%200%200%200-20.1%200L5.3%20197.8c-7.1%207.1-7.1%2018.6%200%2025.7s18.6%207.1%2025.7%200l113.8-113.8L261.3%20223.5c7.1%207.1%2018.6%207.1%2025.7%200s7.1-18.6%200-25.7z%22%2F%3E%3C%2Fsvg%3E') no-repeat right 10px center;
            background-size: 12px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            margin-top: 10px;
        }
        
        .btn-danger:hover {
            background-color: #b02a37;
        }

        /* DATA LISTS (TRANSACTIONS & ESTIMATES) */
        .data-list {
            margin-top: 15px;
        }

        .data-item {
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-description {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 3px;
        }

        .item-meta {
            font-size: 0.85em;
            color: #6c757d;
        }

        .item-amount {
            font-weight: 700;
            font-size: 1.2em;
            margin-left: 10px;
        }

        .income {
            color: #28a745;
        }

        .expense {
            color: #dc3545;
        }
        
        .estimate-item {
            border-left: 5px solid #ffc107; /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô */
        }
        
        .estimate .item-amount {
            color: #ffc107;
        }

        .data-list h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .delete-btn, .forward-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            padding: 0;
            width: auto;
            transition: color 0.2s;
        }
        
        .forward-btn {
            color: #007bff;
        }

        .delete-btn:hover, .forward-btn:hover {
            color: #000;
        }
        
        /* LOGIN PAGE */
        .login-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-form {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 350px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #007bff;
        }

        /* NOTIFICATION */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            color: white;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .notification-bar.show {
            display: block;
            opacity: 1;
        }

        .notification-bar.success {
            background-color: #28a745;
        }

        .notification-bar.error {
            background-color: #dc3545;
        }

        .notification-bar.info {
            background-color: #ffc107;
            color: #333;
        }
        
        /* SETTLEMENT TABLE */
        .settlement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .settlement-table th, .settlement-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        
        .settlement-table th {
            background-color: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .settlement-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .settlement-table .net-balance-cell {
            font-weight: bold;
        }
        
        .settlement-table .credit {
            color: #28a745;
        }
        
        .settlement-table .debt {
            color: #dc3545;
        }

        /* MOBILE OPTIMIZATION */
        @media (min-width: 601px) {
            .container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body>

    <div class="notification-bar" id="notificationBar"></div>

    <div id="mainApp" style="display: none;">
        <header>
            <h1 id="accountNameTitle">Pool Villa Budget App</h1>
            <div class="status-bar">
                <div class="user-status">
                    üßë <span id="loggedInUser"></span>
                </div>
                <button onclick="logout()" style="background-color: transparent; color: white; border: 1px solid white; padding: 5px 10px; font-size: 0.8em; margin-left: 10px; width: auto;">
                    Logout
                </button>
            </div>
        </header>
        
        <div class="container">
            <div id="balanceBox" class="balance-box">
                <div class="balance-title">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô)</div>
                <div id="availableBalance" class="balance-amount">0.00</div>
                <div class="sub-balance-info">
                    <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: <span id="currentBalance">0.00</span></span>
                    <span>‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: <span id="totalEstimate">0.00</span></span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'AddTransaction')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="tab-button" onclick="openTab(event, 'ViewData')">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                <button class="tab-button" onclick="openTab(event, 'Settlement')">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                <button class="tab-button" onclick="openTab(event, 'Advanced')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button>
            </div>

            <div id="AddTransaction" class="tab-content active">
                <div class="form-group">
                    <label for="transactionType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <select id="transactionType" onchange="toggleIncomeExpenseFields()">
                        <option value="EXPENSE">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                        <option value="INCOME">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                    </select>
                </div>
                
                <div id="expenseFields">
                    <div class="form-group">
                        <label for="expensePaidBy">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (Credit)</label>
                        <select id="expensePaidBy" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</label>
                        <select id="paymentType" required>
                            <option value="POOL">‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á (Pool)</option>
                            <option value="INDIVIDUAL">‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏´‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</option>
                        </select>
                    </div>
                </div>
                
                <div id="incomeFields" style="display:none;">
                    <div class="form-group">
                        <label for="incomeMember">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</label>
                        <select id="incomeMember">
                            <option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô Sponsor (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï) --</option>
                            </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transactionAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionDescription">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                    <input type="text" id="transactionDescription" placeholder="‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô, ‡∏Ø‡∏•‡∏Ø" required>
                </div>
                
                <button class="btn-primary" onclick="addTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                
                <h3 style="margin-top: 30px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (Estimate)</h3>
                <p style="font-size: 0.9em; color: #666;">‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</p>
                <div class="form-group">
                    <label for="estimateAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ</label>
                    <input type="number" id="estimateAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="estimateDescription">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</label>
                    <input type="text" id="estimateDescription" placeholder="‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á">
                </div>
                <button class="btn-primary" onclick="addEstimate()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
            </div>

            <div id="ViewData" class="tab-content">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div id="transactionList" class="data-list">
                    </div>
                
                <h3 style="margin-top: 30px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</h3>
                <div id="estimateList" class="data-list">
                    </div>
            </div>

            <div id="Settlement" class="tab-content">
                <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                <p style="font-size: 0.9em; color: #666;">‡∏¢‡∏≠‡∏î‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∑‡∏≠ **‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô)**, ‡∏¢‡∏≠‡∏î‡∏•‡∏ö‡∏Ñ‡∏∑‡∏≠ **‡∏´‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°)**</p>
                
                <table id="settlementTable" class="settlement-table">
                    <thead>
                        <tr>
                            <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                            <th>‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Advance)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (Credit)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Debit)</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                
                <h3 style="margin-top: 20px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Advance)</h3>
                <div id="advanceList" class="data-list">
                    </div>
            </div>

            <div id="Advanced" class="tab-content">
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="form-group">
                    <label for="newMemberName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                    <input type="text" id="newMemberName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" required>
                </div>
                <button class="btn-primary" onclick="addMember()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                
                <h3 style="margin-top: 30px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (Advance)</h3>
                <div class="form-group">
                    <label for="advanceMember">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <select id="advanceMember" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="advanceAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</label>
                    <input type="number" id="advanceAmount" placeholder="0.00" step="0.01" required>
                </div>
                <button class="btn-primary" onclick="addAdvance()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>
                
                <button class="btn-danger" style="margin-top: 50px;" onclick="clearActiveUsers()">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)</button>
            </div>

        </div> </div> <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h2>Pool Villa Budget App</h2>
            <div class="form-group">
                <label for="loginUser">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                <input type="text" id="loginUser" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢, ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•" required>
            </div>
            <div class="form-group">
                <label for="passcode">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="passcode" required>
            </div>
            <button class="btn-primary" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>
    
    <script>
        // *** 1. CONFIGURATION & STATE ***
        const LOGGED_IN_USER_KEY = 'poolVillaBudgetAppUser';
        let allMembers = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let currentData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Apps Script

        // *** 2. CORE APIS ***
        // Core API Call (Uses GET method for all data exchange)
        function postData(payload) {
            return new Promise((resolve, reject) => {
                // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ checkAutoLogin(); ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Redirect ‡∏ñ‡πâ‡∏≤ Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                // checkAutoLogin(); 
                
                google.script.run
                    .withSuccessHandler(result => {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô Server (Code.gs) ‡∏à‡∏∞‡∏™‡πà‡∏á success: false ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                        if (result && result.success === false) {
                             reject(result.message || 'Server returned failure.');
                             return;
                        }
                        resolve(result);
                    })
                    .withFailureHandler(error => {
                        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô Script function not found)
                        console.error('Apps Script Call Failed:', error);
                        reject(error);
                    })
                    .doGet(payload); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å doGet ‡πÉ‡∏ô Code.gs 
            });
        }
        
        // --- DATA RETRIEVAL ---
        async function loadAllData() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (Transactions, Estimates, Balances)
                const payload = { action: 'GET_DATA' };
                const result = await postData(payload);

                if (result.success) {
                    currentData = result;
                    updateBalanceBox(result);
                    renderTransactions(result.transactions);
                    renderEstimates(result.estimates);
                    
                    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ render Settlement Data 
                    const settlementPayload = { action: 'GET_SETTLEMENT_DATA' };
                    const settlementResult = await postData(settlementPayload);
                    if (settlementResult.success) {
                        renderSettlement(settlementResult);
                    } else {
                        throw new Error(settlementResult.message);
                    }
                    
                    showNotification('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            }
        }
        
        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Login
        // async function loadLoginData() {
            // try {
            //     const result = await postData({ action: 'GET_MEMBERS' });
            //     if (result.success && result.members) {
            //         allMembers = result.members;
            //         populateMemberSelects();
            //         // populate Login dropdown
            //         const loginSelect = document.getElementById('loginUser');
            //         loginSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ --</option>';
            //         result.members.forEach(member => {
            //             const option = document.createElement('option');
            //             option.value = member;
            //             option.textContent = member;
            //             loginSelect.appendChild(option);
            //         });
            //     } else {
            //         showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'error');
            //     }
            // } catch (error) {
            //     showNotification(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Login ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            // }
        // }
        
        // --- UTILITY ---
        function formatCurrency(amount) {
            if (typeof amount !== 'number') return 'N/A';
            return amount.toLocaleString('th-TH', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }) + ' ‡∏ø';
        }
        
        function populateMemberSelects() {
            const selects = [
                document.getElementById('expensePaidBy'),
                document.getElementById('incomeMember'),
                document.getElementById('advanceMember')
            ];
            
            selects.forEach(select => {
                const selectedValue = select.id === 'incomeMember' ? select.value : localStorage.getItem(LOGGED_IN_USER_KEY);
                select.innerHTML = '';
                
                if (select.id === 'incomeMember') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô Sponsor (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï) --';
                    select.appendChild(defaultOption);
                }
                
                allMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    select.appendChild(option);
                    
                    if (member === selectedValue) {
                        option.selected = true;
                    }
                });
            });
        }
        
        // *** 3. UI RENDERING ***
        function updateBalanceBox(data) {
            const availableBalanceEl = document.getElementById('availableBalance');
            const currentBalanceEl = document.getElementById('currentBalance');
            const totalEstimateEl = document.getElementById('totalEstimate');
            
            const available = parseFloat(data.availableBalance) || 0;
            const current = parseFloat(data.currentBalance) || 0;
            const estimate = parseFloat(data.totalEstimate) || 0;

            availableBalanceEl.textContent = formatCurrency(available);
            availableBalanceEl.classList.toggle('negative', available < 0);
            
            currentBalanceEl.textContent = formatCurrency(current);
            totalEstimateEl.textContent = formatCurrency(estimate);

            document.getElementById('accountNameTitle').textContent = data.accountName || 'Pool Villa Budget App';
        }

        function renderTransactions(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';

            transactions.slice().reverse().forEach((t, index) => {
                const originalIndex = transactions.length - 1 - index; // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Index ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô Sheet
                
                const item = document.createElement('div');
                item.className = 'data-item';
                
                const amount = parseFloat(t.Amount) || 0;
                const typeClass = t.Type === 'INCOME' ? 'income' : 'expense';
                
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${t.Description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</div>
                        <div class="item-meta">
                            ${t.Type} | ${t.PaidBy ? '‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ' + t.PaidBy + ' (' + t.PaymentType + ')' : ''} |
                            ${new Date(t.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount ${typeClass}">${formatCurrency(amount)}</div>
                    <button class="delete-btn" onclick="deleteTransaction(${originalIndex})" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
            
            if (transactions.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p>';
            }
        }

        function renderEstimates(estimates) {
            const list = document.getElementById('estimateList');
            list.innerHTML = '';
            
            estimates.slice().reverse().forEach((e, index) => {
                const originalIndex = estimates.length - 1 - index;
                
                const item = document.createElement('div');
                item.className = 'data-item estimate-item';
                
                const amount = parseFloat(e.Amount) || 0;
                
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">${e.Description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}</div>
                        <div class="item-meta">
                            ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢: ${e.User} |
                            ${new Date(e.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount estimate">${formatCurrency(amount)}</div>
                    <button class="forward-btn" onclick="forwardEstimate(${originalIndex})" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á">‚úÖ</button>
                    <button class="delete-btn" onclick="deleteEstimate(${originalIndex})" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô">üóëÔ∏è</button>
                `;
                list.appendChild(item);
            });
            
            if (estimates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</p>';
            }
        }
        
        function renderSettlement(data) {
            const tableBody = document.querySelector('#settlementTable tbody');
            const advanceList = document.getElementById('advanceList');
            tableBody.innerHTML = '';
            advanceList.innerHTML = '';

            const settlementData = data.settlementData;
            const members = data.members;

            members.forEach(member => {
                const s = settlementData[member] || { paidOut: 0, advanceDebt: 0, baseDebit: 0, netBalance: 0 };
                const netClass = s.netBalance >= 0 ? 'credit' : 'debt';
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${member}</td>
                    <td>${formatCurrency(s.advanceDebt)}</td>
                    <td class="credit">${formatCurrency(s.paidOut)}</td>
                    <td class="debt">${formatCurrency(s.baseDebit)}</td>
                    <td class="net-balance-cell ${netClass}">${formatCurrency(s.netBalance)}</td>
                `;
            });
            
            // Render Advance List
            const advanceData = currentData.advance || [];
            advanceData.slice().reverse().forEach(a => {
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `
                    <div class="item-details">
                        <div class="item-description">‡πÄ‡∏ö‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ ${a.MemberName}</div>
                        <div class="item-meta">
                            ${new Date(a.Timestamp).toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' })}
                        </div>
                    </div>
                    <div class="item-amount debt">${formatCurrency(parseFloat(a.Amount) || 0)}</div>
                `;
                advanceList.appendChild(item);
            });
            
            if (advanceData.length === 0) {
                advanceList.innerHTML = '<p style="text-align: center; color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</p>';
            }
        }
        
        // *** 4. AUTHENTICATION & SESSION ***
        async function login() {
            const user = document.getElementById('loginUser').value;
            const passcode = document.getElementById('passcode').value;

            if (!user || !passcode) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                return;
            }
            
            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'info', 60000); // 1 ‡∏ô‡∏≤‡∏ó‡∏µ
            
            try {
                const payload = { action: 'LOGIN', user: user, passcode: passcode };
                const result = await postData(payload);

                if (result.success) {
                    localStorage.setItem(LOGGED_IN_USER_KEY, result.user);
                    document.getElementById('loggedInUser').textContent = result.user;
                    document.getElementById('accountNameTitle').textContent = result.accountName;
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                    
                    populateMemberSelects(); // Set default PaidBy to logged-in user
                    await loadAllData();
                    showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    showNotification(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`, 'error');
                }
            } catch (error) {
                showNotification(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${error.toString()}`, 'error');
            }
        }

        function logout() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            if (user) {
                postData({ action: 'LOGOUT', user: user })
                    .then(result => {
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                        loadLoginData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Login ‡πÉ‡∏´‡∏°‡πà
                    })
                    .catch(error => {
                        // Logout fails on server but we clear client session anyway
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)', 'info');
                        loadLoginData();
                    });
            }
        }
        
        function checkAutoLogin() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            if (user) {
                // Try System check to verify session
                postData({ action: 'LOGIN', user: 'System', passcode: 'System' }) 
                    .then(result => {
                        if (result.success) {
                            document.getElementById('loggedInUser').textContent = user;
                            document.getElementById('accountNameTitle').textContent = result.accountName;
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainApp').style.display = 'flex';
                            populateMemberSelects();
                            loadAllData();
                        } else {
                            // System check failed, force login
                            localStorage.removeItem(LOGGED_IN_USER_KEY);
                            document.getElementById('mainApp').style.display = 'none';
                            document.getElementById('loginScreen').style.display = 'flex';
                            loadLoginData();
                        }
                    })
                    .catch(error => {
                        // Hard error, assume no connection, force login
                        localStorage.removeItem(LOGGED_IN_USER_KEY);
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
                        loadLoginData();
                    });
            } else {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                loadLoginData();
            }
        }

        // *** 5. ACTIONS ***
        
        // Toggle Income/Expense Fields
        function toggleIncomeExpenseFields() {
            const type = document.getElementById('transactionType').value;
            document.getElementById('expenseFields').style.display = (type === 'EXPENSE') ? 'block' : 'none';
            document.getElementById('incomeFields').style.display = (type === 'INCOME') ? 'block' : 'none';
        }
        
        // Add Transaction (Income/Expense)
        async function addTransaction() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const type = document.getElementById('transactionType').value;
            const amount = document.getElementById('transactionAmount').value;
            const description = document.getElementById('transactionDescription').value;
            
            if (!amount || !description || parseFloat(amount) <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            let payload = { 
                action: 'ADD_TRANSACTION',
                user: user,
                type: type,
                amount: amount,
                description: description
            };

            if (type === 'EXPENSE') {
                payload.paidBy = document.getElementById('expensePaidBy').value;
                payload.paymentType = document.getElementById('paymentType').value;
                if (!payload.paidBy || !payload.paymentType) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢', 'error');
                    return;
                }
            } else if (type === 'INCOME') {
                payload.incomeMember = document.getElementById('incomeMember').value; // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
            }

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('transactionAmount').value = '';
                    document.getElementById('transactionDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            }
        }

        // Add Estimate
        async function addEstimate() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const amount = document.getElementById('estimateAmount').value;
            const description = document.getElementById('estimateDescription').value;
            
            if (!amount || !description || parseFloat(amount) <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_ESTIMATE',
                user: user,
                amount: amount,
                description: description
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('estimateAmount').value = '';
                    document.getElementById('estimateDescription').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            }
        }

        // Add Member
        async function addMember() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const memberName = document.getElementById('newMemberName').value.trim();
            
            if (!memberName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_MEMBER',
                user: user,
                memberName: memberName
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('newMemberName').value = '';
                    await loadLoginData(); // Reload member list for all dropdowns
                } else {
                    showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.toString()}`, 'error');
            }
        }
        
        // Add Advance
        async function addAdvance() {
            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            const memberName = document.getElementById('advanceMember').value;
            const amount = document.getElementById('advanceAmount').value;
            
            if (!memberName || !amount || parseFloat(amount) <= 0) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            const payload = { 
                action: 'ADD_ADVANCE',
                user: user,
                memberName: memberName,
                amount: amount
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô...', 'info', 60000);
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('advanceAmount').value = '';
                    await loadAllData();
                } else {
                    showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            }
        }

        // Delete Transaction
        async function deleteTransaction(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 2} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_TRANSACTION',
                user: user,
                rowIndex: dataIndex // rowIndex is 0-based data index (excluding header)
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...', 'info', 60000);
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                await loadAllData(); 
            } else {
                showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }
        
        // Delete Estimate
        async function deleteEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 2} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'DELETE_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };
            
            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...', 'info', 60000);
            const result = await postData(payload);
            
            if (result.success) {
                showNotification('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                await loadAllData();
            } else {
                showNotification(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
            }
        }

        // Forward Estimate to Transaction
        async function forwardEstimate(dataIndex) {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${dataIndex + 2} ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`)) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            const payload = { 
                action: 'FORWARD_ESTIMATE',
                user: user,
                rowIndex: dataIndex 
            };

            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á...', 'info', 60000); 
            
            try {
                const result = await postData(payload);
                if (result.success) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await loadAllData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á 2 ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                } else {
                    showNotification(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.toString()}`, 'error');
            }
        }
        
        // Clear Active Users (Emergency)
        async function clearActiveUsers() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Session ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!')) return;

            const user = localStorage.getItem(LOGGED_IN_USER_KEY);
            
            showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå...', 'info', 60000);
            
            try {
                const result = await postData({ action: 'CLEAR_ACTIVE_USERS', user: user });
                if (result.success) {
                    showNotification('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    showNotification(`‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.message || '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}`, 'error');
                }
            } catch (error) {
                 showNotification(`‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.toString()}`, 'error');
            }
        }

        // *** 6. UI UTILITIES ***

        function openTab(evt, tabName) {
            let i, tabcontent, tabbuttons;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Reload data if needed for the tab
            if (tabName === 'Settlement' || tabName === 'ViewData') {
                loadAllData();
            }
            if (tabName === 'AddTransaction') {
                toggleIncomeExpenseFields();
            }
        }

        function showNotification(message, type, duration = 3000) {
            const bar = document.getElementById('notificationBar');
            
            // Clear previous classes
            bar.className = 'notification-bar';
            
            bar.textContent = message;
            bar.classList.add(type);
            
            // Ensure it's displayed
            requestAnimationFrame(() => {
                bar.classList.add('show');
            });
            

            if (duration > 0) {
                setTimeout(() => {
                    bar.classList.remove('show');
                }, duration);
            }
        }
        
        // Initialize on load
        window.onload = checkAutoLogin;
    </script>
</body>
</html>




